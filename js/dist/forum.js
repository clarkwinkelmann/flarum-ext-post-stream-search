(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var o in e)t.o(e,o)&&!t.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:e[o]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};(()=>{"use strict";t.r(r);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/app"];var s=t.n(o);const a=flarum.core.compat["common/components/Button"];var n=t.n(a);const i=flarum.core.compat["common/components/Tooltip"];var c=t.n(i);const l=flarum.core.compat["forum/components/CommentPost"];var u=t.n(l);const f=flarum.core.compat["forum/components/DiscussionPage"];var h=t.n(f);const d=flarum.core.compat["forum/components/PostStream"];var p=t.n(d);const v=flarum.core.compat["forum/states/PostStreamState"];var b=t.n(v);const g=flarum.core.compat["forum/utils/DiscussionControls"];var y=t.n(g);const w=flarum.core.compat["forum/utils/PostControls"];var P=t.n(w);const I=flarum.core.compat["common/helpers/icon"];var k=t.n(I);function S(t,r){return S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},S(t,r)}const T=flarum.core.compat["common/Component"];var A=t.n(T);const x=flarum.core.compat["common/utils/ItemList"];var F=t.n(x);const O=flarum.core.compat["common/utils/withAttr"];var B=t.n(O);const N=((flarum.extensions["flamarkt-backoffice"]||{}).common||{})["components/UserRelationshipSelect"];var j=t.n(N);const U=flarum.core.compat["common/components/LoadingIndicator"];var C=t.n(U),E=function(t){var r,e;function o(){for(var r,e=arguments.length,o=new Array(e),s=0;s<e;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).searchDebounce=0,r}e=t,(r=o).prototype=Object.create(e.prototype),r.prototype.constructor=r,S(r,e);var a=o.prototype;return a.view=function(){var t=this.actionItems().toArray();return m(".PostStreamToolbarWrapper",m(".container",m(".PostStreamToolbar",[this.filterItems().toArray(),m(".PostStreamToolbar-push"),t,t.length?m(".PostStreamToolbar-separator"):null,this.toolbarControlItems().toArray()])))},a.filterItems=function(){var t=this,r=new(F());return r.add("search",m("input.FormControl.js-post-toolbar-autofocus",{placeholder:s().translator.trans("clarkwinkelmann-post-stream-search.forum.toolbar.searchPlaceholder"),value:this.attrs.stream.filterSearch,oninput:B()("value",(function(r){t.attrs.stream.filterSearch=r,clearTimeout(t.searchDebounce),t.searchDebounce=setTimeout((function(){t.attrs.stream.applyFilters()}),300)}))}),100),r.add("user",m(j(),{relationship:this.attrs.stream.filterUsers,onchange:function(r){t.attrs.stream.filterUsers=r,t.attrs.stream.applyFilters()},placeholder:s().translator.trans("clarkwinkelmann-post-stream-search.forum.toolbar.authorPlaceholder"),suggest:this.suggestUsers()}),50),this.attrs.stream.filterLoading?r.add("loading",C().component({display:"inline"}),-50):Array.isArray(this.attrs.stream.filteredPostIds)&&r.add("summary",m("span.PostStreamToolbarText",s().translator.trans("clarkwinkelmann-post-stream-search.forum.toolbar.summary",{matching:this.attrs.stream.filteredPostIds.length,total:this.attrs.stream.discussion.postIds().length})),-50),r},a.suggestUsers=function(){var t=new Map;return this.attrs.stream.discussion.postIds().forEach((function(r){var e=s().store.getById("posts",r);if(e){var o=e.user();if(o){var a=t.get(o.id())||0;t.set(o.id(),a+1)}}})),Array.from(t.keys()).sort((function(r,e){var o=t.get(r),s=t.get(e);return o>s||s>o?1:0})).map((function(t){return s().store.getById("users",t)}))},a.actionItems=function(){return new(F())},a.toolbarControlItems=function(){var t=this,r=new(F()),e=!!window.localStorage.getItem("showPostStreamToolbar");return r.add("pin",c().component({text:s().translator.trans("clarkwinkelmann-post-stream-search.forum.toolbar.pin")},n().component({className:"Button Button--icon"+(e?" active":""),icon:"fas fa-thumbtack",onclick:function(){e?window.localStorage.removeItem("showPostStreamToolbar"):window.localStorage.setItem("showPostStreamToolbar","1")}})),100),r.add("close",c().component({text:s().translator.trans("clarkwinkelmann-post-stream-search.forum.toolbar."+(e?"clear":"close"))},n().component({className:"Button Button--icon",icon:"fas fa-times",onclick:function(){e||(t.attrs.stream.showToolbar=!1),t.attrs.stream.clearFilters()}})),50),r},o}(A());s().initializers.add("clarkwinkelmann-post-stream-search",(function(){(0,e.extend)(h().prototype,"pageContent",(function(t){this.stream&&this.stream.showToolbar&&t.add("stream-toolbar",m(E,{stream:this.stream}),-200)})),(0,e.extend)(b().prototype,"show",(function(){void 0===this.showToolbar&&(this.showToolbar=!!window.localStorage.getItem("showPostStreamToolbar"),this.filterSearch="",this.filterUsers=[],this.filteredPostIds=null,this.filterLoading=!1)})),(0,e.override)(b().prototype,"loadRange",(function(t,r,e){if(!Array.isArray(this.filteredPostIds))return t(r,e);var o=[],a=[];return this.filteredPostIds.slice(r,e).forEach((function(t){var r=s().store.getById("posts",t);r&&r.discussion()&&void 0!==r.canEdit()?a.push(r):o.push(t)})),o.length?s().store.find("posts",o).then((function(t){return a.concat(t).sort((function(t,r){return t.number()-r.number()}))})):Promise.resolve(a)})),(0,e.override)(b().prototype,"show",(function(t,r){var e;if(!Array.isArray(this.filteredPostIds))return t(r);this.visibleStart=r.length?this.filteredPostIds.indexOf(null!=(e=r[0].id())?e:"0"):0,this.visibleEnd=this.sanitizeIndex(this.visibleStart+r.length)})),(0,e.override)(b().prototype,"posts",(function(t){return Array.isArray(this.filteredPostIds)?this.filteredPostIds.slice(this.visibleStart,this.visibleEnd).map((function(t){var r=s().store.getById("posts",t);return r&&r.discussion()&&void 0!==r.canEdit()?r:null})):t()})),(0,e.override)(b().prototype,"count",(function(t){return Array.isArray(this.filteredPostIds)?this.filteredPostIds.length:t()})),(0,e.override)(b().prototype,"loadNearNumber",(function(t,r){var e=this;if(!Array.isArray(this.filteredPostIds))return t(r);if(this.posts().some((function(t){return t&&Number(t.number())===Number(r)})))return Promise.resolve();var o=function(){var t,o=n().component({className:"Button Button--link",onclick:function(){e.clearFilters(r),s().alerts.dismiss(t)}},s().translator.trans("clarkwinkelmann-post-stream-search.forum.cannotGoToPost.action"));t=s().alerts.show({controls:[o]},s().translator.trans("clarkwinkelmann-post-stream-search.forum.cannotGoToPost.message"))};return s().store.all("posts").some((function(t){return Number(t.number())===Number(r)&&t.discussion()===e.discussion}))?(o(),Promise.resolve()):(this.reset(),this.retrieveFilteredDiscussion(r).then((function(t){var a=[],n=!1;t.data.forEach((function(t){if(t.attributes){var e=s().store.pushObject(t);a.push(e),Number(e.number())===Number(r)&&(n=!0)}})),e.show(a),n||o()})))})),(0,e.override)(b().prototype,"update",(function(t){var r=this;return Array.isArray(this.filteredPostIds)?new Promise((function(e){r.retrieveFilteredDiscussion().then((function(){t().then((function(){e()}))}))})):t()})),b().prototype.retrieveFilteredDiscussion=function(t){var r=this,e={};return this.filterSearch&&(e.q=this.filterSearch),this.filterUsers.length>0&&(e.author=this.filterUsers.map((function(t){return t.username()})).join(",")),this.filterLoading=!0,s().request({method:"GET",url:s().forum.attribute("apiUrl")+"/discussions/"+this.discussion.id()+"/posts-search",params:{filter:e,page:{near:t}}}).then((function(t){return r.filteredPostIds=[],t.data.forEach((function(t){r.filteredPostIds.push(t.id)})),r.filterLoading=!1,t}))},b().prototype.applyFilters=function(t){var r=this,e=s().route.discussion(this.discussion)+"/",o=window.location.pathname;if(t||0!==o.indexOf(e)||(t=parseInt(o.substr(e.length))),!this.filterSearch&&0===this.filterUsers.length)return this.filteredPostIds=null,void(t?this.goToNumber(t):this.goToFirst());this.retrieveFilteredDiscussion(t).then((function(e){var o=null,a=1e3,n=[];e.data.forEach((function(r){if(r.attributes){var e=s().store.pushObject(r);if(n.push(e),null===o&&(o=e),t){var i=Math.abs(e.number()-t);i<a&&(a=i,o=e)}}})),r.show(n),m.redraw(),o?r.goToNumber(o.number()):r.goToFirst()}))},b().prototype.clearFilters=function(t){this.filterSearch="",this.filterUsers=[],this.applyFilters(t)},window.addEventListener("keydown",(function(t){if((t.ctrlKey||t.metaKey)&&"F"===t.key&&s().current.matches(h())){var r=s().current.get("stream");r&&(t.preventDefault(),r.showToolbar=!0,m.redraw(),setTimeout((function(){$(".js-post-toolbar-autofocus").trigger("focus")}),0))}})),(0,e.extend)(p().prototype,"view",(function(t){var r=this;if(Array.isArray(this.stream.filteredPostIds))if(0!==this.stream.filteredPostIds.length){var e=this.discussion.postIds(),o="clarkwinkelmann-post-stream-search.forum.stream."+(this.stream.filterSearch?"unmatchedGap":"otherAuthorsGap");t.children.forEach((function(t){if(t.attrs&&t.attrs["data-id"]){var a=e.indexOf(t.attrs["data-id"]),n=r.stream.filteredPostIds.indexOf(t.attrs["data-id"]);if(!(a<0||n<0)&&(0===n&&a>0&&t.children.unshift(m(".PostStream-timeGap",s().translator.trans(o,{count:a}))),a!==e.length-1)){var i=r.stream.filteredPostIds[n+1],c=n+1>=r.stream.filteredPostIds.length?e.length:e.indexOf(i);if(!(c<0)){var l=c-a-1;l<=0||t.children.push(m(".PostStream-timeGap",s().translator.trans(o,{count:l})))}}}}))}else t.children.unshift(m(".PostStream-filterNoResults",[k()("fas fa-search"),m("div",s().translator.trans("clarkwinkelmann-post-stream-search.forum.stream.noResults"))]))})),(0,e.extend)(y(),"userControls",(function(t){s().forum.attribute("post-stream-search.dropdownAccess")&&t.add("filter-toolbar",n().component({onclick:function(){var t=s().current.get("stream");t&&(t.showToolbar=!0,setTimeout((function(){$(".js-post-toolbar-autofocus").trigger("focus")}),0))},icon:"fas fa-search"},s().translator.trans("clarkwinkelmann-post-stream-search.forum.discussionControls.searchInDiscussion")))})),(0,e.extend)(P(),"userControls",(function(t,r){if(s().forum.attribute("post-stream-search.authorQuickFilter")){var e=r.user();e&&t.add("filter-author",n().component({onclick:function(){var t=s().current.get("stream");t&&(t.showToolbar=!0,t.filterSearch="",t.filterUsers=[e],t.applyFilters())},icon:"fas fa-filter"},s().translator.trans("clarkwinkelmann-post-stream-search.forum.postControls.authorFilter")))}})),(0,e.extend)(u().prototype,"headerItems",(function(t){if(s().forum.attribute("post-stream-search.originalPosterBadge")){var r=this.attrs.post.user(),e=this.attrs.post.discussion();r&&r===e.user()&&t.add("original-poster",c().component({text:s().translator.trans("clarkwinkelmann-post-stream-search.forum.post.opBadgeTooltip")},m("span.OriginalPosterBadge",{onclick:function(){var t=s().current.get("stream");t&&(t.showToolbar=!0,t.filterSearch="",t.filterUsers=[r],t.applyFilters())}},s().translator.trans("clarkwinkelmann-post-stream-search.forum.post.opBadge"))))}}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map